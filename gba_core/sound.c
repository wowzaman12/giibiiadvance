/*
    GiiBiiAdvance - GBA/GB  emulator
    Copyright (C) 2011 Antonio Niño Díaz (AntonioND)

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "../build_options.h"

#include "memory.h"
#include "dma.h"
#include "sound.h"
#include "cpu.h"

#ifdef WIN32
#include "../frontend/windows/main.h"
#endif
#include "../frontend/config.h"

#define GBA_BUFFER_SIZE (16384) //Yeah... quite a lot, but it works fine this way.
                                //The bigger, the less possibilities to underflow,
                                //but the more delay between actions and sound output...
                                //ONLY POWERS OF 2
#define GBA_BUFFER_SAMPLES (GBA_BUFFER_SIZE/2)


static const s8 SquareWave[4][32] = {
	{ -128,-128,-128,-128, -128,-128,-128,-128, 127,127,-128,-128, -128,-128,-128,-128,
	  -128,-128,-128,-128, -128,-128,-128,-128, 127,127,-128,-128, -128,-128,-128,-128 },

	{ -128,-128,-128,-128, -128,-128,-128,-128, 127,127,127,127, -128,-128,-128,-128,
	  -128,-128,-128,-128, -128,-128,-128,-128, 127,127,127,127, -128,-128,-128,-128 },

	{ -128,-128,-128,-128, 127,127,127,127, 127,127,127,127, -128,-128,-128,-128,
	  -128,-128,-128,-128, 127,127,127,127, 127,127,127,127, -128,-128,-128,-128 },

	{ 127,127,127,127, 127,127,127,127, -128,-128,-128,-128, 127,127,127,127,
	  127,127,127,127, 127,127,127,127, -128,-128,-128,-128, 127,127,127,127}
	};

static s8 WavePattern[64];

//extern const uint8_t noise_7[16]; //See gb_core/noise.c
//extern const uint8_t noise_15[4096];

const u8 noise_7[16] = {
	0x01,0xfb,0xe7,0xae,0x1b,0xa6,0x2b,0x05,0xe3,0xb6,0x4a,0x42,0x72,0xd1,0x19,0xaa
};

const u8 noise_15[4096] = {
	0x00,0x01,0xff,0xfb,0xff,0xe7,0xff,0xaf,0xfe,0x1f,0xfb,0xbf,0xe6,0x7f,0xaa,0xfe,
	0x01,0xfb,0xfb,0xe7,0xe7,0xaf,0xae,0x1e,0x1b,0xbb,0xa6,0x66,0x2a,0xab,0x00,0x05,
	0xff,0xe3,0xff,0xb7,0xfe,0x4f,0xfa,0x5f,0xe2,0x3f,0xb3,0x7e,0x54,0xfa,0x05,0xe3,
	0xe3,0xb7,0xb6,0x4e,0x4a,0x5a,0x42,0x22,0x73,0x32,0xd5,0x51,0x00,0x19,0xff,0xab,
	0xfe,0x07,0xfb,0xef,0xe7,0x9f,0xae,0xbe,0x18,0x7b,0xae,0xe6,0x19,0xab,0xaa,0x06,
	0x03,0xeb,0xf7,0x87,0xce,0xef,0x59,0x9c,0x2a,0xb7,0x00,0x4d,0xfe,0x53,0xfa,0x17,
	0xe3,0x8f,0xb6,0xde,0x49,0x3a,0x49,0x62,0x48,0xb2,0x4c,0x52,0x56,0x12,0x0b,0x93,
	0xc6,0x97,0x68,0x8c,0x8c,0xd4,0xd5,0x05,0x01,0xe1,0xfb,0xbb,0xe6,0x67,0xaa,0xae,
	0x00,0x1b,0xff,0xa7,0xfe,0x2f,0xfb,0x1f,0xe5,0xbf,0xa2,0x7e,0x32,0xfb,0x51,0xe4,
	0x1b,0xa7,0xa6,0x2e,0x2b,0x1b,0x05,0xa5,0xe2,0x23,0xb3,0x36,0x55,0x4a,0x00,0x43,
	0xfe,0x77,0xfa,0xcf,0xe1,0x5f,0xb8,0x3e,0x6f,0x7a,0x9c,0xe0,0xb5,0xbc,0x42,0x76,
	0x72,0xca,0xd1,0x41,0x18,0x79,0xae,0xea,0x19,0x83,0xaa,0xf6,0x01,0xcb,0xfb,0x47,
	0xe4,0x6f,0xa6,0x9e,0x28,0xbb,0x0c,0x65,0xd6,0xa3,0x08,0x35,0xcf,0x43,0x5c,0x74,
	0x36,0xc7,0x49,0x6c,0x48,0x96,0x4c,0x8a,0x54,0xc2,0x05,0x73,0xe0,0xd7,0xbd,0x0e,
	0x71,0xda,0xdb,0x21,0x25,0x39,0x21,0x69,0x38,0x89,0x6c,0xc8,0x95,0x4c,0x80,0x54,
	0xfe,0x05,0xfb,0xe3,0xe7,0xb7,0xae,0x4e,0x1a,0x5b,0xa2,0x26,0x33,0x2b,0x55,0x04,
	0x01,0xe7,0xfb,0xaf,0xe6,0x1f,0xab,0xbe,0x06,0x7b,0xea,0xe7,0x81,0xae,0xfa,0x19,
	0xe3,0xab,0xb6,0x06,0x4b,0xea,0x47,0x82,0x6e,0xf2,0x99,0xd0,0xab,0x1c,0x05,0xb7,
	0xe2,0x4f,0xb2,0x5e,0x52,0x3a,0x13,0x63,0x94,0xb6,0x84,0x48,0xe6,0x4d,0xaa,0x52,
	0x02,0x13,0xf3,0x97,0xd6,0x8f,0x08,0xdd,0xcd,0x33,0x51,0x54,0x18,0x07,0xaf,0xee,
	0x1f,0x9b,0xbe,0xa6,0x78,0x2a,0xef,0x01,0x9d,0xfa,0xb3,0xe0,0x57,0xbe,0x0e,0x7b,
	0xda,0xe7,0x21,0xad,0x3a,0x11,0x63,0x98,0xb6,0xac,0x48,0x16,0x4f,0x8a,0x5e,0xc2,
	0x39,0x73,0x68,0xd4,0x8d,0x04,0xd1,0xe5,0x1b,0xa1,0xa6,0x3a,0x2b,0x63,0x04,0xb5,
	0xe4,0x43,0xa6,0x76,0x2a,0xcb,0x01,0x45,0xf8,0x63,0xee,0xb7,0x98,0x4e,0xae,0x58,
	0x1a,0x2f,0xa3,0x1e,0x35,0xbb,0x42,0x64,0x72,0xa6,0xd0,0x29,0x1f,0x09,0xbd,0xca,
	0x73,0x42,0xd4,0x71,0x06,0xd9,0xe9,0x2b,0x89,0x06,0xc9,0xe9,0x4b,0x88,0x46,0xce,
	0x69,0x5a,0x88,0x20,0xcf,0x3d,0x5d,0x70,0x30,0xdf,0x5d,0x3c,0x31,0x77,0x58,0xcc,
	0x2d,0x57,0x10,0x0d,0x9f,0xd2,0xbf,0x10,0x7d,0x9e,0xf2,0xb9,0xd0,0x6b,0x1e,0x85,
	0xb8,0xe2,0x6d,0xb2,0x92,0x50,0x92,0x1c,0x93,0xb4,0x96,0x44,0x8a,0x64,0xc2,0xa5,
	0x70,0x20,0xdf,0x3d,0x3d,0x71,0x70,0xd8,0xdd,0x2d,0x31,0x11,0x59,0x98,0x2a,0xaf,
	0x00,0x1d,0xff,0xb3,0xfe,0x57,0xfa,0x0f,0xe3,0xdf,0xb7,0x3e,0x4d,0x7a,0x50,0xe2,
	0x1d,0xb3,0xb2,0x56,0x52,0x0a,0x13,0xc3,0x97,0x76,0x8c,0xc8,0xd5,0x4d,0x00,0x51,
	0xfe,0x1b,0xfb,0xa7,0xe6,0x2f,0xab,0x1e,0x05,0xbb,0xe2,0x67,0xb2,0xae,0x50,0x1a,
	0x1f,0xa3,0xbe,0x36,0x7b,0x4a,0xe4,0x41,0xa6,0x7a,0x2a,0xe3,0x01,0xb5,0xfa,0x43,
	0xe2,0x77,0xb2,0xce,0x51,0x5a,0x18,0x23,0xaf,0x36,0x1d,0x4b,0xb0,0x46,0x5e,0x6a,
	0x3a,0x83,0x60,0xf4,0xbd,0xc4,0x73,0x66,0xd4,0xa9,0x04,0x09,0xe7,0xcb,0xaf,0x46,
	0x1c,0x6b,0xb6,0x86,0x48,0xea,0x4d,0x82,0x52,0xf2,0x11,0xd3,0x9b,0x16,0xa5,0x88,
	0x22,0xcf,0x31,0x5d,0x58,0x30,0x2f,0x5f,0x1c,0x3d,0xb7,0x72,0x4c,0xd2,0x55,0x12,
	0x01,0x93,0xfa,0x97,0xe0,0x8f,0xbc,0xde,0x75,0x3a,0xc1,0x61,0x78,0xb8,0xec,0x6d,
	0x96,0x92,0x88,0x90,0xcc,0x9d,0x54,0xb0,0x04,0x5f,0xe6,0x3f,0xab,0x7e,0x04,0xfb,
	0xe5,0xe7,0xa3,0xae,0x36,0x1b,0x4b,0xa4,0x46,0x26,0x6b,0x2a,0x85,0x00,0xe1,0xfd,
	0xbb,0xf2,0x67,0xd2,0xaf,0x10,0x1d,0x9f,0xb2,0xbe,0x50,0x7a,0x1e,0xe3,0xb9,0xb6,
	0x6a,0x4a,0x82,0x40,0xf2,0x7d,0xd2,0xf3,0x11,0xd5,0x9b,0x02,0xa5,0xf0,0x23,0xdf,
	0x37,0x3d,0x4d,0x70,0x50,0xde,0x1d,0x3b,0xb1,0x66,0x58,0xaa,0x2c,0x03,0x17,0xf5,
	0x8f,0xc2,0xdf,0x71,0x3c,0xd9,0x75,0x28,0xc1,0x0d,0x79,0xd0,0xeb,0x1d,0x85,0xb2,
	0xe2,0x51,0xb2,0x1a,0x53,0xa2,0x16,0x33,0x8b,0x56,0xc4,0x09,0x67,0xc8,0xaf,0x4c,
	0x1c,0x57,0xb6,0x0e,0x4b,0xda,0x47,0x22,0x6d,0x32,0x91,0x50,0x98,0x1c,0xaf,0xb4,
	0x1e,0x47,0xba,0x6e,0x62,0x9a,0xb0,0xa0,0x5c,0x3e,0x37,0x7b,0x4c,0xe4,0x55,0xa6,
	0x02,0x2b,0xf3,0x07,0xd5,0xef,0x03,0x9d,0xf6,0xb3,0xc8,0x57,0x4e,0x0c,0x5b,0xd6,
	0x27,0x0b,0x2d,0xc5,0x13,0x61,0x94,0xba,0x84,0x60,0xe6,0xbd,0xa8,0x72,0x0e,0xd3,
	0xd9,0x17,0x29,0x8d,0x0a,0xd1,0xc1,0x1b,0x79,0xa4,0xea,0x25,0x83,0x22,0xf5,0x31,
	0xc1,0x5b,0x78,0x24,0xef,0x25,0x9d,0x22,0xb1,0x30,0x59,0x5e,0x28,0x3b,0x0f,0x65,
	0xdc,0xa3,0x34,0x35,0x47,0x40,0x6c,0x7e,0x96,0xf8,0x89,0xec,0xcb,0x95,0x46,0x80,
	0x68,0xfe,0x8d,0xf8,0xd3,0xed,0x17,0x91,0x8e,0x9a,0xd8,0xa1,0x2c,0x39,0x17,0x69,
	0x8c,0x8a,0xd4,0xc1,0x05,0x79,0xe0,0xeb,0xbd,0x86,0x72,0xea,0xd1,0x81,0x1a,0xf9,
	0xa1,0xea,0x3b,0x83,0x66,0xf4,0xa9,0xc4,0x0b,0x67,0xc4,0xaf,0x64,0x1c,0xa7,0xb4,
	0x2e,0x47,0x1a,0x6d,0xa2,0x92,0x30,0x93,0x5c,0x94,0x34,0x87,0x44,0xec,0x65,0x96,
	0xa2,0x88,0x30,0xcf,0x5d,0x5c,0x30,0x37,0x5f,0x4c,0x3c,0x57,0x76,0x0c,0xcb,0xd5,
	0x47,0x00,0x6d,0xfe,0x93,0xf8,0x97,0xec,0x8f,0x94,0xde,0x85,0x38,0xe1,0x6d,0xb8,
	0x92,0x6c,0x92,0x94,0x90,0x84,0x9c,0xe4,0xb5,0xa4,0x42,0x26,0x73,0x2a,0xd5,0x01,
	0x01,0xf9,0xfb,0xeb,0xe7,0x87,0xae,0xee,0x19,0x9b,0xaa,0xa6,0x00,0x2b,0xff,0x07,
	0xfd,0xef,0xf3,0x9f,0xd6,0xbf,0x08,0x7d,0xce,0xf3,0x59,0xd4,0x2b,0x07,0x05,0xed,
	0xe3,0x93,0xb6,0x96,0x48,0x8a,0x4c,0xc2,0x55,0x72,0x00,0xd3,0xfd,0x17,0xf1,0x8f,
	0xda,0xdf,0x21,0x3d,0x39,0x71,0x68,0xd8,0x8d,0x2c,0xd1,0x15,0x19,0x81,0xaa,0xfa,
	0x01,0xe3,0xfb,0xb7,0xe6,0x4f,0xaa,0x5e,0x02,0x3b,0xf3,0x67,0xd4,0xaf,0x04,0x1d,
	0xe7,0xb3,0xae,0x56,0x1a,0x0b,0xa3,0xc6,0x37,0x6b,0x4c,0x84,0x54,0xe6,0x05,0xab,
	0xe2,0x07,0xb3,0xee,0x57,0x9a,0x0e,0xa3,0xd8,0x37,0x2f,0x4d,0x1c,0x51,0xb6,0x1a,
	0x4b,0xa2,0x46,0x32,0x6b,0x52,0x84,0x10,0xe7,0x9d,0xae,0xb2,0x18,0x53,0xae,0x16,
	0x1b,0x8b,0xa6,0xc6,0x29,0x6b,0x08,0x85,0xcc,0xe3,0x55,0xb4,0x02,0x47,0xf2,0x6f,
	0xd2,0x9f,0x10,0xbd,0x9c,0x72,0xb6,0xd0,0x49,0x1e,0x49,0xba,0x4a,0x62,0x42,0xb2,
	0x70,0x52,0xde,0x11,0x3b,0x99,0x66,0xa8,0xa8,0x0c,0x0f,0xd7,0xdf,0x0f,0x3d,0xdd,
	0x73,0x30,0xd5,0x5d,0x00,0x31,0xff,0x5b,0xfc,0x27,0xf7,0x2f,0xcd,0x1f,0x51,0xbc,
	0x1a,0x77,0xa2,0xce,0x31,0x5b,0x58,0x24,0x2f,0x27,0x1d,0x2d,0xb1,0x12,0x59,0x92,
	0x2a,0x93,0x00,0x95,0xfc,0x83,0xf4,0xf7,0xc5,0xcf,0x63,0x5c,0xb4,0x34,0x47,0x46,
	0x6c,0x6a,0x96,0x80,0x88,0xfc,0xcd,0xf5,0x53,0xc0,0x17,0x7f,0x8c,0xfe,0xd5,0xf9,
	0x03,0xe9,0xf7,0x8b,0xce,0xc7,0x59,0x6c,0x28,0x97,0x0c,0x8d,0xd4,0xd3,0x05,0x15,
	0xe1,0x83,0xba,0xf6,0x61,0xca,0xbb,0x40,0x64,0x7e,0xa6,0xf8,0x29,0xef,0x0b,0x9d,
	0xc6,0xb3,0x68,0x54,0x8e,0x04,0xdb,0xe5,0x27,0xa1,0x2e,0x39,0x1b,0x69,0xa4,0x8a,
	0x24,0xc3,0x25,0x75,0x20,0xc1,0x3d,0x79,0x70,0xe8,0xdd,0x8d,0x32,0xd1,0x51,0x18,
	0x19,0xaf,0xaa,0x1e,0x03,0xbb,0xf6,0x67,0xca,0xaf,0x40,0x1c,0x7f,0xb6,0xfe,0x49,
	0xfa,0x4b,0xe2,0x47,0xb2,0x6e,0x52,0x9a,0x10,0xa3,0x9c,0x36,0xb7,0x48,0x4c,0x4e,
	0x56,0x5a,0x0a,0x23,0xc3,0x37,0x75,0x4c,0xc0,0x55,0x7e,0x00,0xfb,0xfd,0xe7,0xf3,
	0xaf,0xd6,0x1f,0x0b,0xbd,0xc6,0x73,0x6a,0xd4,0x81,0x04,0xf9,0xe5,0xeb,0xa3,0x86,
	0x36,0xeb,0x49,0x84,0x4a,0xe6,0x41,0xaa,0x7a,0x02,0xe3,0xf1,0xb7,0xda,0x4f,0x22,
	0x5d,0x32,0x31,0x53,0x58,0x14,0x2f,0x87,0x1e,0xed,0xb9,0x92,0x6a,0x92,0x80,0x90,
	0xfc,0x9d,0xf4,0xb3,0xc4,0x57,0x66,0x0c,0xab,0xd4,0x07,0x07,0xed,0xef,0x93,0x9e,
	0x96,0xb8,0x88,0x6c,0xce,0x95,0x58,0x80,0x2c,0xff,0x15,0xfd,0x83,0xf2,0xf7,0xd1,
	0xcf,0x1b,0x5d,0xa4,0x32,0x27,0x53,0x2c,0x15,0x17,0x81,0x8e,0xfa,0xd9,0xe1,0x2b,
	0xb9,0x06,0x69,0xea,0x8b,0x80,0xc6,0xfd,0x69,0xf0,0x8b,0xdc,0xc7,0x35,0x6d,0x40,
	0x90,0x7c,0x9e,0xf4,0xb9,0xc4,0x6b,0x66,0x84,0xa8,0xe4,0x0d,0xa7,0xd2,0x2f,0x13,
	0x1d,0x95,0xb2,0x82,0x50,0xf2,0x1d,0xd3,0xb3,0x16,0x55,0x8a,0x02,0xc3,0xf1,0x77,
	0xd8,0xcf,0x2d,0x5d,0x10,0x31,0x9f,0x5a,0xbc,0x20,0x77,0x3e,0xcd,0x79,0x50,0xe8,
	0x1d,0x8f,0xb2,0xde,0x51,0x3a,0x19,0x63,0xa8,0xb6,0x0c,0x4b,0xd6,0x47,0x0a,0x6d,
	0xc2,0x93,0x70,0x94,0xdc,0x85,0x34,0xe1,0x45,0xb8,0x62,0x6e,0xb2,0x98,0x50,0xae,
	0x1c,0x1b,0xb7,0xa6,0x4e,0x2a,0x5b,0x02,0x25,0xf3,0x23,0xd5,0x37,0x01,0x4d,0xf8,
	0x53,0xee,0x17,0x9b,0x8e,0xa6,0xd8,0x29,0x2f,0x09,0x1d,0xc9,0xb3,0x4a,0x54,0x42,
	0x06,0x73,0xea,0xd7,0x81,0x0e,0xf9,0xd9,0xeb,0x2b,0x85,0x06,0xe1,0xe9,0xbb,0x8a,
	0x66,0xc2,0xa9,0x70,0x08,0xdf,0xcd,0x3f,0x51,0x7c,0x18,0xf7,0xad,0xce,0x13,0x5b,
	0x94,0x26,0x87,0x28,0xed,0x0d,0x91,0xd2,0x9b,0x10,0xa5,0x9c,0x22,0xb7,0x30,0x4d,
	0x5e,0x50,0x3a,0x1f,0x63,0xbc,0xb6,0x74,0x4a,0xc6,0x41,0x6a,0x78,0x82,0xec,0xf1,
	0x95,0xda,0x83,0x20,0xf5,0x3d,0xc1,0x73,0x78,0xd4,0xed,0x05,0x91,0xe2,0x9b,0xb0,
	0xa6,0x5c,0x2a,0x37,0x03,0x4d,0xf4,0x53,0xc6,0x17,0x6b,0x8c,0x86,0xd4,0xe9,0x05,
	0x89,0xe2,0xcb,0xb1,0x46,0x58,0x6a,0x2e,0x83,0x18,0xf5,0xad,0xc2,0x13,0x73,0x94,
	0xd6,0x85,0x08,0xe1,0xcd,0xbb,0x52,0x64,0x12,0xa7,0x90,0x2e,0x9f,0x18,0xbd,0xac,
	0x72,0x16,0xd3,0x89,0x16,0xc9,0x89,0x4a,0xc8,0x41,0x4e,0x78,0x5a,0xee,0x21,0x9b,
	0x3a,0xa5,0x60,0x20,0xbf,0x3c,0x7d,0x76,0xf0,0xc9,0xdd,0x4b,0x30,0x45,0x5e,0x60,
	0x3a,0xbf,0x60,0x7c,0xbe,0xf4,0x79,0xc6,0xeb,0x69,0x84,0x8a,0xe4,0xc1,0xa5,0x7a,
	0x20,0xe3,0x3d,0xb5,0x72,0x40,0xd2,0x7d,0x12,0xf1,0x91,0xda,0x9b,0x20,0xa5,0x3c,
	0x21,0x77,0x38,0xcd,0x6d,0x50,0x90,0x1c,0x9f,0xb4,0xbe,0x44,0x7a,0x66,0xe2,0xa9,
	0xb0,0x0a,0x5f,0xc2,0x3f,0x73,0x7c,0xd4,0xf5,0x05,0xc1,0xe3,0x7b,0xb4,0xe6,0x45,
	0xaa,0x62,0x02,0xb3,0xf0,0x57,0xde,0x0f,0x3b,0xdd,0x67,0x30,0xad,0x5c,0x10,0x37,
	0x9f,0x4e,0xbc,0x58,0x76,0x2e,0xcb,0x19,0x45,0xa8,0x62,0x0e,0xb3,0xd8,0x57,0x2e,
	0x0d,0x1b,0xd1,0xa7,0x1a,0x2d,0xa3,0x12,0x35,0x93,0x42,0x94,0x70,0x86,0xdc,0xe9,
	0x35,0x89,0x42,0xc8,0x71,0x4e,0xd8,0x59,0x2e,0x29,0x1b,0x09,0xa5,0xca,0x23,0x43,
	0x34,0x75,0x46,0xc0,0x69,0x7e,0x88,0xf8,0xcd,0xed,0x53,0x90,0x16,0x9f,0x88,0xbe,
	0xcc,0x79,0x56,0xe8,0x09,0x8f,0xca,0xdf,0x41,0x3c,0x79,0x76,0xe8,0xc9,0x8d,0x4a,
	0xd0,0x41,0x1e,0x79,0xba,0xea,0x61,0x82,0xba,0xf0,0x61,0xde,0xbb,0x38,0x65,0x6e,
	0xa0,0x98,0x3c,0xaf,0x74,0x1c,0xc7,0xb5,0x6e,0x40,0x9a,0x7c,0xa2,0xf4,0x31,0xc7,
	0x5b,0x6c,0x24,0x97,0x24,0x8d,0x24,0xd1,0x25,0x19,0x21,0xa9,0x3a,0x09,0x63,0xc8,
	0xb7,0x4c,0x4c,0x56,0x56,0x0a,0x0b,0xc3,0xc7,0x77,0x6c,0xcc,0x95,0x54,0x80,0x04,
	0xff,0xe5,0xff,0xa3,0xfe,0x37,0xfb,0x4f,0xe4,0x5f,0xa6,0x3e,0x2b,0x7b,0x04,0xe5,
	0xe5,0xa3,0xa2,0x36,0x33,0x4b,0x54,0x44,0x06,0x67,0xea,0xaf,0x80,0x1e,0xff,0xb9,
	0xfe,0x6b,0xfa,0x87,0xe0,0xef,0xbd,0x9e,0x72,0xba,0xd0,0x61,0x1e,0xb9,0xb8,0x6a,
	0x6e,0x82,0x98,0xf0,0xad,0xdc,0x13,0x37,0x95,0x4e,0x80,0x58,0xfe,0x2d,0xfb,0x13,
	0xe5,0x97,0xa2,0x8e,0x30,0xdb,0x5d,0x24,0x31,0x27,0x59,0x2c,0x29,0x17,0x09,0x8d,
	0xca,0xd3,0x41,0x14,0x79,0x86,0xea,0xe9,0x81,0x8a,0xfa,0xc1,0xe1,0x7b,0xb8,0xe6,
	0x6d,0xaa,0x92,0x00,0x93,0xfc,0x97,0xf4,0x8f,0xc4,0xdf,0x65,0x3c,0xa1,0x74,0x38,
	0xc7,0x6d,0x6c,0x90,0x94,0x9c,0x84,0xb4,0xe4,0x45,0xa6,0x62,0x2a,0xb3,0x00,0x55,
	0xfe,0x03,0xfb,0xf7,0xe7,0xcf,0xaf,0x5e,0x1c,0x3b,0xb7,0x66,0x4c,0xaa,0x54,0x02,
	0x07,0xf3,0xef,0xd7,0x9f,0x0e,0xbd,0xd8,0x73,0x2e,0xd5,0x19,0x01,0xa9,0xfa,0x0b,
	0xe3,0xc7,0xb7,0x6e,0x4c,0x9a,0x54,0xa2,0x04,0x33,0xe7,0x57,0xac,0x0e,0x17,0xdb,
	0x8f,0x26,0xdd,0x29,0x31,0x09,0x59,0xc8,0x2b,0x4f,0x04,0x5d,0xe6,0x33,0xab,0x56,
	0x04,0x0b,0xe7,0xc7,0xaf,0x6e,0x1c,0x9b,0xb4,0xa6,0x44,0x2a,0x67,0x02,0xad,0xf0,
	0x13,0xdf,0x97,0x3e,0x8d,0x78,0xd0,0xed,0x1d,0x91,0xb2,0x9a,0x50,0xa2,0x1c,0x33,
	0xb7,0x56,0x4c,0x0a,0x57,0xc2,0x0f,0x73,0xdc,0xd7,0x35,0x0d,0x41,0xd0,0x7b,0x1e,
	0xe5,0xb9,0xa2,0x6a,0x32,0x83,0x50,0xf4,0x1d,0xc7,0xb3,0x6e,0x54,0x9a,0x04,0xa3,
	0xe4,0x37,0xa7,0x4e,0x2c,0x5b,0x16,0x25,0x8b,0x22,0xc5,0x31,0x61,0x58,0xb8,0x2c,
	0x6f,0x16,0x9d,0x88,0xb2,0xcc,0x51,0x56,0x18,0x0b,0xaf,0xc6,0x1f,0x6b,0xbc,0x86,
	0x74,0xea,0xc5,0x81,0x62,0xf8,0xb1,0xec,0x5b,0x96,0x26,0x8b,0x28,0xc5,0x0d,0x61,
	0xd0,0xbb,0x1c,0x65,0xb6,0xa2,0x48,0x32,0x4f,0x52,0x5c,0x12,0x37,0x93,0x4e,0x94,
	0x58,0x86,0x2c,0xeb,0x15,0x85,0x82,0xe2,0xf1,0xb1,0xda,0x5b,0x22,0x25,0x33,0x21,
	0x55,0x38,0x01,0x6f,0xf8,0x9f,0xec,0xbf,0x94,0x7e,0x86,0xf8,0xe9,0xed,0x8b,0x92,
	0xc6,0x91,0x68,0x98,0x8c,0xac,0xd4,0x15,0x07,0x81,0xee,0xfb,0x99,0xe6,0xab,0xa8,
	0x06,0x0f,0xeb,0xdf,0x87,0x3e,0xed,0x79,0x90,0xea,0x9d,0x80,0xb2,0xfc,0x51,0xf6,
	0x1b,0xcb,0xa7,0x46,0x2c,0x6b,0x16,0x85,0x88,0xe2,0xcd,0xb1,0x52,0x58,0x12,0x2f,
	0x93,0x1e,0x95,0xb8,0x82,0x6c,0xf2,0x95,0xd0,0x83,0x1c,0xf5,0xb5,0xc2,0x43,0x72,
	0x74,0xd2,0xc5,0x11,0x61,0x98,0xba,0xac,0x60,0x16,0xbf,0x88,0x7e,0xce,0xf9,0x59,
	0xe8,0x2b,0x8f,0x06,0xdd,0xe9,0x33,0x89,0x56,0xc8,0x09,0x4f,0xc8,0x5f,0x4e,0x3c,
	0x5b,0x76,0x24,0xcb,0x25,0x45,0x20,0x61,0x3e,0xb9,0x78,0x68,0xee,0x8d,0x98,0xd2,
	0xad,0x10,0x11,0x9f,0x9a,0xbe,0xa0,0x78,0x3e,0xef,0x79,0x9c,0xea,0xb5,0x80,0x42,
	0xfe,0x71,0xfa,0xdb,0xe1,0x27,0xb9,0x2e,0x69,0x1a,0x89,0xa0,0xca,0x3d,0x43,0x70,
	0x74,0xde,0xc5,0x39,0x61,0x68,0xb8,0x8c,0x6c,0xd6,0x95,0x08,0x81,0xcc,0xfb,0x55,
	0xe4,0x03,0xa7,0xf6,0x2f,0xcb,0x1f,0x45,0xbc,0x62,0x76,0xb2,0xc8,0x51,0x4e,0x18,
	0x5b,0xae,0x26,0x1b,0x2b,0xa5,0x06,0x21,0xeb,0x3b,0x85,0x66,0xe0,0xa9,0xbc,0x0a,
	0x77,0xc2,0xcf,0x71,0x5c,0xd8,0x35,0x2f,0x41,0x1c,0x79,0xb6,0xea,0x49,0x82,0x4a,
	0xf2,0x41,0xd2,0x7b,0x12,0xe5,0x91,0xa2,0x9a,0x30,0xa3,0x5c,0x34,0x37,0x47,0x4c,
	0x6c,0x56,0x96,0x08,0x8b,0xcc,0xc7,0x55,0x6c,0x00,0x97,0xfc,0x8f,0xf4,0xdf,0xc5,
	0x3f,0x61,0x7c,0xb8,0xf4,0x6d,0xc6,0x93,0x68,0x94,0x8c,0x84,0xd4,0xe5,0x05,0xa1,
	0xe2,0x3b,0xb3,0x66,0x54,0xaa,0x04,0x03,0xe7,0xf7,0xaf,0xce,0x1f,0x5b,0xbc,0x26,
	0x77,0x2a,0xcd,0x01,0x51,0xf8,0x1b,0xef,0xa7,0x9e,0x2e,0xbb,0x18,0x65,0xae,0xa2,
	0x18,0x33,0xaf,0x56,0x1c,0x0b,0xb7,0xc6,0x4f,0x6a,0x5c,0x82,0x34,0xf3,0x45,0xd4,
	0x63,0x06,0xb5,0xe8,0x43,0x8e,0x76,0xda,0xc9,0x21,0x49,0x38,0x49,0x6e,0x48,0x9a,
	0x4c,0xa2,0x54,0x32,0x07,0x53,0xec,0x17,0x97,0x8e,0x8e,0xd8,0xd9,0x2d,0x29,0x11,
	0x09,0x99,0xca,0xab,0x40,0x04,0x7f,0xe6,0xff,0xa9,0xfe,0x0b,0xfb,0xc7,0xe7,0x6f,
	0xac,0x9e,0x14,0xbb,0x84,0x66,0xe6,0xa9,0xa8,0x0a,0x0f,0xc3,0xdf,0x77,0x3c,0xcd,
	0x75,0x50,0xc0,0x1d,0x7f,0xb0,0xfe,0x5d,0xfa,0x33,0xe3,0x57,0xb4,0x0e,0x47,0xda,
	0x6f,0x22,0x9d,0x30,0xb1,0x5c,0x58,0x36,0x2f,0x4b,0x1c,0x45,0xb6,0x62,0x4a,0xb2,
	0x40,0x52,0x7e,0x12,0xfb,0x91,0xe6,0x9b,0xa8,0xa6,0x0c,0x2b,0xd7,0x07,0x0d,0xed,
	0xd3,0x93,0x16,0x95,0x88,0x82,0xcc,0xf1,0x55,0xd8,0x03,0x2f,0xf5,0x1f,0xc1,0xbf,
	0x7a,0x7c,0xe2,0xf5,0xb1,0xc2,0x5b,0x72,0x24,0xd3,0x25,0x15,0x21,0x81,0x3a,0xf9,
	0x61,0xe8,0xbb,0x8c,0x66,0xd6,0xa9,0x08,0x09,0xcf,0xcb,0x5f,0x44,0x3c,0x67,0x76,
	0xac,0xc8,0x15,0x4f,0x80,0x5e,0xfe,0x39,0xfb,0x6b,0xe4,0x87,0xa4,0xee,0x25,0x9b,
	0x22,0xa5,0x30,0x21,0x5f,0x38,0x3d,0x6f,0x70,0x9c,0xdc,0xb5,0x34,0x41,0x46,0x78,
	0x6a,0xee,0x81,0x98,0xfa,0xad,0xe0,0x13,0xbf,0x96,0x7e,0x8a,0xf8,0xc1,0xed,0x7b,
	0x90,0xe6,0x9d,0xa8,0xb2,0x0c,0x53,0xd6,0x17,0x0b,0x8d,0xc6,0xd3,0x69,0x14,0x89,
	0x84,0xca,0xe5,0x41,0xa0,0x7a,0x3e,0xe3,0x79,0xb4,0xea,0x45,0x82,0x62,0xf2,0xb1,
	0xd0,0x5b,0x1e,0x25,0xbb,0x22,0x65,0x32,0xa1,0x50,0x38,0x1f,0x6f,0xbc,0x9e,0x74,
	0xba,0xc4,0x61,0x66,0xb8,0xa8,0x6c,0x0e,0x97,0xd8,0x8f,0x2c,0xdd,0x15,0x31,0x81,
	0x5a,0xf8,0x21,0xef,0x3b,0x9d,0x66,0xb0,0xa8,0x5c,0x0e,0x37,0xdb,0x4f,0x24,0x5d,
	0x26,0x31,0x2b,0x59,0x04,0x29,0xe7,0x0b,0xad,0xc6,0x13,0x6b,0x94,0x86,0x84,0xe8,
	0xe5,0x8d,0xa2,0xd2,0x31,0x13,0x59,0x94,0x2a,0x87,0x00,0xed,0xfd,0x93,0xf2,0x97,
	0xd0,0x8f,0x1c,0xdd,0xb5,0x32,0x41,0x52,0x78,0x12,0xef,0x91,0x9e,0x9a,0xb8,0xa0,
	0x6c,0x3e,0x97,0x78,0x8c,0xec,0xd5,0x95,0x02,0x81,0xf0,0xfb,0xdd,0xe7,0x33,0xad,
	0x56,0x10,0x0b,0x9f,0xc6,0xbf,0x68,0x7c,0x8e,0xf4,0xd9,0xc5,0x2b,0x61,0x04,0xb9,
	0xe4,0x6b,0xa6,0x86,0x28,0xeb,0x0d,0x85,0xd2,0xe3,0x11,0xb5,0x9a,0x42,0xa2,0x70,
	0x32,0xdf,0x51,0x3c,0x19,0x77,0xa8,0xce,0x0d,0x5b,0xd0,0x27,0x1f,0x2d,0xbd,0x12,
	0x71,0x92,0xda,0x91,0x20,0x99,0x3c,0xa9,0x74,0x08,0xc7,0xcd,0x6f,0x50,0x9c,0x1c,
	0xb7,0xb4,0x4e,0x46,0x5a,0x6a,0x22,0x83,0x30,0xf5,0x5d,0xc0,0x33,0x7f,0x54,0xfc,
	0x05,0xf7,0xe3,0xcf,0xb7,0x5e,0x4c,0x3a,0x57,0x62,0x0c,0xb3,0xd4,0x57,0x06,0x0d,
	0xeb,0xd3,0x87,0x16,0xed,0x89,0x92,0xca,0x91,0x40,0x98,0x7c,0xae,0xf4,0x19,0xc7,
	0xab,0x6e,0x04,0x9b,0xe4,0xa7,0xa4,0x2e,0x27,0x1b,0x2d,0xa5,0x12,0x21,0x93,0x3a,
	0x95,0x60,0x80,0xbc,0xfc,0x75,0xf6,0xc3,0xc9,0x77,0x48,0xcc,0x4d,0x56,0x50,0x0a,
	0x1f,0xc3,0xbf,0x76,0x7c,0xca,0xf5,0x41,0xc0,0x7b,0x7e,0xe4,0xf9,0xa5,0xea,0x23,
	0x83,0x36,0xf5,0x49,0xc0,0x4b,0x7e,0x44,0xfa,0x65,0xe2,0xa3,0xb0,0x36,0x5f,0x4a,
	0x3c,0x43,0x76,0x74,0xca,0xc5,0x41,0x60,0x78,0xbe,0xec,0x79,0x96,0xea,0x89,0x80,
	0xca,0xfd,0x41,0xf0,0x7b,0xde,0xe7,0x39,0xad,0x6a,0x10,0x83,0x9c,0xf6,0xb5,0xc8,
	0x43,0x4e,0x74,0x5a,0xc6,0x21,0x6b,0x38,0x85,0x6c,0xe0,0x95,0xbc,0x82,0x74,0xf2,
	0xc5,0xd1,0x63,0x18,0xb5,0xac,0x42,0x16,0x73,0x8a,0xd6,0xc1,0x09,0x79,0xc8,0xeb,
	0x4d,0x84,0x52,0xe6,0x11,0xab,0x9a,0x06,0xa3,0xe8,0x37,0x8f,0x4e,0xdc,0x59,0x36,
	0x29,0x4b,0x08,0x45,0xce,0x63,0x5a,0xb4,0x20,0x47,0x3e,0x6d,0x7a,0x90,0xe0,0x9d,
	0xbc,0xb2,0x74,0x52,0xc6,0x11,0x6b,0x98,0x86,0xac,0xe8,0x15,0x8f,0x82,0xde,0xf1,
	0x39,0xd9,0x6b,0x28,0x85,0x0c,0xe1,0xd5,0xbb,0x02,0x65,0xf2,0xa3,0xd0,0x37,0x1f,
	0x4d,0xbc,0x52,0x76,0x12,0xcb,0x91,0x46,0x98,0x68,0xae,0x8c,0x18,0xd7,0xad,0x0e,
	0x11,0xdb,0x9b,0x26,0xa5,0x28,0x21,0x0f,0x39,0xdd,0x6b,0x30,0x85,0x5c,0xe0,0x35,
	0xbf,0x42,0x7c,0x72,0xf6,0xd1,0xc9,0x1b,0x49,0xa4,0x4a,0x26,0x43,0x2a,0x75,0x02,
	0xc1,0xf1,0x7b,0xd8,0xe7,0x2d,0xad,0x12,0x11,0x93,0x9a,0x96,0xa0,0x88,0x3c,0xcf,
	0x75,0x5c,0xc0,0x35,0x7f,0x40,0xfc,0x7d,0xf6,0xf3,0xc9,0xd7,0x4b,0x0c,0x45,0xd6,
	0x63,0x0a,0xb5,0xc0,0x43,0x7e,0x74,0xfa,0xc5,0xe1,0x63,0xb8,0xb6,0x6c,0x4a,0x96,
	0x40,0x8a,0x7c,0xc2,0xf5,0x71,0xc0,0xdb,0x7d,0x24,0xf1,0x25,0xd9,0x23,0x29,0x35,
	0x09,0x41,0xc8,0x7b,0x4e,0xe4,0x59,0xa6,0x2a,0x2b,0x03,0x05,0xf5,0xe3,0xc3,0xb7,
	0x76,0x4c,0xca,0x55,0x42,0x00,0x73,0xfe,0xd7,0xf9,0x0f,0xe9,0xdf,0x8b,0x3e,0xc5,
	0x79,0x60,0xe8,0xbd,0x8c,0x72,0xd6,0xd1,0x09,0x19,0xc9,0xab,0x4a,0x04,0x43,0xe6,
	0x77,0xaa,0xce,0x01,0x5b,0xf8,0x27,0xef,0x2f,0x9d,0x1e,0xb1,0xb8,0x5a,0x6e,0x22,
	0x9b,0x30,0xa5,0x5c,0x20,0x37,0x3f,0x4d,0x7c,0x50,0xf6,0x1d,0xcb,0xb3,0x46,0x54,
	0x6a,0x06,0x83,0xe8,0xf7,0x8d,0xce,0xd3,0x59,0x14,0x29,0x87,0x0a,0xed,0xc1,0x93,
	0x7a,0x94,0xe0,0x85,0xbc,0xe2,0x75,0xb2,0xc2,0x51,0x72,0x18,0xd3,0xad,0x16,0x11,
	0x8b,0x9a,0xc6,0xa1,0x68,0x38,0x8f,0x6c,0xdc,0x95,0x34,0x81,0x44,0xf8,0x65,0xee,
	0xa3,0x98,0x36,0xaf,0x48,0x1c,0x4f,0xb6,0x5e,0x4a,0x3a,0x43,0x62,0x74,0xb2,0xc4,
	0x51,0x66,0x18,0xab,0xac,0x06,0x17,0xeb,0x8f,0x86,0xde,0xe9,0x39,0x89,0x6a,0xc8,
	0x81,0x4c,0xf8,0x55,0xee,0x03,0x9b,0xf6,0xa7,0xc8,0x2f,0x4f,0x1c,0x5d,0xb6,0x32,
	0x4b,0x52,0x44,0x12,0x67,0x92,0xae,0x90,0x18,0x9f,0xac,0xbe,0x14,0x7b,0x86,0xe6,
	0xe9,0xa9,0x8a,0x0a,0xc3,0xc1,0x77,0x78,0xcc,0xed,0x55,0x90,0x02,0x9f,0xf0,0xbf,
	0xdc,0x7f,0x36,0xfd,0x49,0xf0,0x4b,0xde,0x47,0x3a,0x6d,0x62,0x90,0xb0,0x9c,0x5c,
	0xb6,0x34,0x4b,0x46,0x44,0x6a,0x66,0x82,0xa8,0xf0,0x0d,0xdf,0xd3,0x3f,0x15,0x7d,
	0x80,0xf2,0xfd,0xd1,0xf3,0x1b,0xd5,0xa7,0x02,0x2d,0xf3,0x13,0xd5,0x97,0x02,0x8d,
	0xf0,0xd3,0xdd,0x17,0x31,0x8d,0x5a,0xd0,0x21,0x1f,0x39,0xbd,0x6a,0x70,0x82,0xdc,
	0xf1,0x35,0xd9,0x43,0x28,0x75,0x0e,0xc1,0xd9,0x7b,0x28,0xe5,0x0d,0xa1,0xd2,0x3b,
	0x13,0x65,0x94,0xa2,0x84,0x30,0xe7,0x5d,0xac,0x32,0x17,0x53,0x8c,0x16,0xd7,0x89,
	0x0e,0xc9,0xd9,0x4b,0x28,0x45,0x0e,0x61,0xda,0xbb,0x20,0x65,0x3e,0xa1,0x78,0x38,
	0xef,0x6d,0x9c,0x92,0xb4,0x90,0x44,0x9e,0x64,0xba,0xa4,0x60,0x26,0xbf,0x28,0x7d,
	0x0e,0xf1,0xd9,0xdb,0x2b,0x25,0x05,0x21,0xe1,0x3b,0xb9,0x66,0x68,0xaa,0x8c,0x00,
	0xd7,0xfd,0x0f,0xf1,0xdf,0xdb,0x3f,0x25,0x7d,0x20,0xf1,0x3d,0xd9,0x73,0x28,0xd5,
	0x0d,0x01,0xd1,0xfb,0x1b,0xe5,0xa7,0xa2,0x2e,0x33,0x1b,0x55,0xa4,0x02,0x27,0xf3,
	0x2f,0xd5,0x1f,0x01,0xbd,0xfa,0x73,0xe2,0xd7,0xb1,0x0e,0x59,0xda,0x2b,0x23,0x05,
	0x35,0xe1,0x43,0xb8,0x76,0x6e,0xca,0x99,0x40,0xa8,0x7c,0x0e,0xf7,0xd9,0xcf,0x2b,
	0x5d,0x04,0x31,0xe7,0x5b,0xac,0x26,0x17,0x2b,0x8d,0x06,0xd1,0xe9,0x1b,0x89,0xa6,
	0xca,0x29,0x43,0x08,0x75,0xce,0xc3,0x59,0x74,0x28,0xc7,0x0d,0x6d,0xd0,0x93,0x1c,
	0x95,0xb4,0x82,0x44,0xf2,0x65,0xd2,0xa3,0x10,0x35,0x9f,0x42,0xbc,0x70,0x76,0xde,
	0xc9,0x39,0x49,0x68,0x48,0x8e,0x4c,0xda,0x55,0x22,0x01,0x33,0xf9,0x57,0xe8,0x0f,
	0x8f,0xde,0xdf,0x39,0x3d,0x69,0x70,0x88,0xdc,0xcd,0x35,0x51,0x40,0x18,0x7f,0xae,
	0xfe,0x19,0xfb,0xab,0xe6,0x07,0xab,0xee,0x07,0x9b,0xee,0xa7,0x98,0x2e,0xaf,0x18,
	0x1d,0xaf,0xb2,0x1e,0x53,0xba,0x16,0x63,0x8a,0xb6,0xc0,0x49,0x7e,0x48,0xfa,0x4d,
	0xe2,0x53,0xb2,0x16,0x53,0x8a,0x16,0xc3,0x89,0x76,0xc8,0xc9,0x4d,0x48,0x50,0x4e,
	0x1e,0x5b,0xba,0x26,0x63,0x2a,0xb5,0x00,0x41,0xfe,0x7b,0xfa,0xe7,0xe1,0xaf,0xba,
	0x1e,0x63,0xba,0xb6,0x60,0x4a,0xbe,0x40,0x7a,0x7e,0xe2,0xf9,0xb1,0xea,0x5b,0x82,
	0x26,0xf3,0x29,0xd5,0x0b,0x01,0xc5,0xfb,0x63,0xe4,0xb7,0xa4,0x4e,0x26,0x5b,0x2a,
	0x25,0x03,0x21,0xf5,0x3b,0xc1,0x67,0x78,0xac,0xec,0x15,0x97,0x82,0x8e,0xf0,0xd9,
	0xdd,0x2b,0x31,0x05,0x59,0xe0,0x2b,0xbf,0x06,0x7d,0xea,0xf3,0x81,0xd6,0xfb,0x09,
	0xe5,0xcb,0xa3,0x46,0x34,0x6b,0x46,0x84,0x68,0xe6,0x8d,0xa8,0xd2,0x0d,0x13,0xd1,
	0x97,0x1a,0x8d,0xa0,0xd2,0x3d,0x13,0x71,0x94,0xda,0x85,0x20,0xe1,0x3d,0xb9,0x72,
	0x68,0xd2,0x8d,0x10,0xd1,0x9d,0x1a,0xb1,0xa0,0x5a,0x3e,0x23,0x7b,0x34,0xe5,0x45,
	0xa0,0x62,0x3e,0xb3,0x78,0x54,0xee,0x05,0x9b,0xe2,0xa7,0xb0,0x2e,0x5f,0x1a,0x3d,
	0xa3,0x72,0x34,0xd3,0x45,0x14,0x61,0x86,0xba,0xe8,0x61,0x8e,0xba,0xd8,0x61,0x2e,
	0xb9,0x18,0x69,0xae,0x8a,0x18,0xc3,0xad,0x76,0x10,0xcb,0x9d,0x46,0xb0,0x68,0x5e,
	0x8e,0x38,0xdb,0x6d,0x24,0x91,0x24,0x99,0x24,0xa9,0x24,0x09,0x27,0xc9,0x2f,0x49,
	0x1c,0x49,0xb6,0x4a,0x4a,0x42,0x42,0x72,0x72,0xd2,0xd1,0x11,0x19,0x99,0xaa,0xaa
};

typedef struct
	{
	struct { //Tone & Sweep
	    u16 reg[3];

		s32 freq;

		u32 sweepstepsleft;
		u32 sweeptime; // if 0, not active
		u32 sweepinc;
		u32 sweepshift;
        u32 sweepfreq;

		u32 duty;

		u32 vol;
		u32 envactive; // if != 0, activate
		u32 envelope;
		u32 envincrease;
		u32 envstepstochange;

		u32 stepsleft; //Each step is 1/256 sec
		u32 limittime; //Activates "stepsleft"

		u32 speakerright;
		u32 speakerleft;


        u32 running;
        u32 outfreq;
		u32 samplecount;
    } Chn1;

	struct { //Tone
	    u16 reg[3];

		s32 freq;
		u32 duty;

		u32 vol;
		u32 envactive; // if != 0, activate
		u32 envelope;
		u32 envincrease;
		u32 envstepstochange;

		u32 stepsleft; //Each step is 1/256 sec
		u32 limittime; //Activates "stepsleft"

		u32 speakerright;
		u32 speakerleft;


        u32 running;
        u32 outfreq;
		u32 samplecount;
    } Chn2;

	struct { //Wave Output
	    u16 reg[5];

		u32 playing;

		s32 freq;

		u32 vol;

		u32 stepsleft; //Each step is 1/256 sec
		u32 limittime; //Activates "stepsleft"

		u32 speakerright;
		u32 speakerleft;

        int doublesize; //0 - 1
        int buffer_playing; // 0 - 1
        u8 wave_ram_buffer[2][16];

		u32 running;
		u32 outfreq;
		u32 samplecount;
    } Chn3;

	struct { //Noise
	    u16 reg[5];

		u32 shift;
		u32 width_7;
		s32 freq_ratio;

		u32 vol;
		u32 envactive; // if != 0, activate
		u32 envelope;
		u32 envincrease;
		u32 envstepstochange;

		u32 stepsleft; //Each step is 1/256 sec
		u32 limittime; //Activates "stepsleft"

		u32 speakerright;
		u32 speakerleft;


        int seed;

		u32 running;
        u32 outfreq;
		u32 samplecount;
    } Chn4;

    #define FIFO_BUFFER_SIZE 128
    struct { //DMA A
        int vol;

        u32 speakerright;
		u32 speakerleft;

		u32 timer; //timer 0 - 1

        int cursample;
        int cursamplewrite;
        u8 buffer[FIFO_BUFFER_SIZE];
        int datalen;

        u8 out_sample;

        u32 running;
    } FifoA;

    struct { //DMA B
        int vol;

        u32 speakerright;
		u32 speakerleft;

		u32 timer; //timer 0 - 1

        int cursample;
        int cursamplewrite;
        u8 buffer[FIFO_BUFFER_SIZE];
        int datalen;

        u8 out_sample;

        u32 running;
    } FifoB;

	u32 leftvol;
	u32 rightvol;
	u32 clocks;

	int PSG_master_volume;

    u32 nextsample_clocks;
    s16 buffer[GBA_BUFFER_SIZE/2];
    u32 buffer_next_input_sample;
    u32 buffer_next_output_sample;
    int samples_left_to_input;
    int samples_left_to_output;

    //some temporal variables to avoid stupid operations every time a sample is going to be
    //generated...:
    int leftvol_1, rightvol_1;
    int leftvol_2, rightvol_2;
    int leftvol_3, rightvol_3;
    int leftvol_4, rightvol_4;

    int leftvol_A, rightvol_A;
    int leftvol_B, rightvol_B;

	u32 master_enable;
	} _GBA_SOUND_HARDWARE_;

static _GBA_SOUND_HARDWARE_ Sound;

static int output_enabled;

inline int GBA_SoundHardwareIsOn(void)
{
    return Sound.master_enable;
}

void GBA_SoundPowerOff(void)
{
    GBA_SoundRegWrite16(SOUND1CNT_L,0);
    GBA_SoundRegWrite16(SOUND1CNT_H,0);
    GBA_SoundRegWrite16(SOUND1CNT_X,0);
    GBA_SoundRegWrite16(SOUND2CNT_L,0);
    GBA_SoundRegWrite16(SOUND2CNT_H,0);
    GBA_SoundRegWrite16(SOUND3CNT_L,0);
    GBA_SoundRegWrite16(SOUND3CNT_H,0);
    GBA_SoundRegWrite16(SOUND3CNT_X,0);
    GBA_SoundRegWrite16(SOUND4CNT_L,0);
    GBA_SoundRegWrite16(SOUND4CNT_H,0);
    GBA_SoundRegWrite16(SOUNDCNT_L,0);
    GBA_SoundRegWrite16(SOUNDCNT_H,0);
    //GBA_SoundRegWrite16(SOUNDCNT_X,0); <-- Infinite loop!

    Sound.Chn1.running = 0;
    Sound.Chn2.running = 0;
    Sound.Chn3.running = 0;
    Sound.Chn4.running = 0;

    Sound.FifoA.running = 0;
    Sound.FifoB.running = 0;
}

void GBA_SoundPowerOn(void)
{
    //reset this values...
	Sound.Chn1.sweeptime = 0;
	Sound.Chn1.envactive = 0;
	Sound.Chn1.limittime = 0;

	Sound.Chn2.envactive = 0;
	Sound.Chn2.limittime = 0;

	Sound.Chn3.playing = 0;
	Sound.Chn3.limittime = 0;

	Sound.Chn4.envactive = 0;
	Sound.Chn4.limittime = 0;
	Sound.Chn4.seed = 0xFF;

	Sound.FifoA.out_sample = 0;
	Sound.FifoA.cursample = 0;
    Sound.FifoA.cursamplewrite = 0;
    memset(Sound.FifoA.buffer,0,sizeof(Sound.FifoA.buffer));
    Sound.FifoA.datalen = 0;

    Sound.FifoB.out_sample = 0;
	Sound.FifoB.cursample = 0;
    Sound.FifoB.cursamplewrite = 0;
    memset(Sound.FifoB.buffer,0,sizeof(Sound.FifoB.buffer));
    Sound.FifoB.datalen = 0;
}

void GBA_SoundCallback(void * buffer, long len)
{
    if((output_enabled == 0) || EmulatorConfig.snd_mute)
    {
        memset(buffer,0,len);
        return;
    }

    //Should print: (GBA_BUFFER_SAMPLES / 3 * 2) - (GBA_BUFFER_SAMPLES / 3)
    //char strrrrr[204];
    //sprintf(strrrrr,"%d, %d - %d %s",len, Sound.samples_left_to_input,Sound.samples_left_to_output,
    //Sound.samples_left_to_output > Sound.samples_left_to_input-(GBA_BUFFER_SAMPLES/2)?"SLOW":"FAST");
    //GLWindow_SetCaption((const char*)strrrrr);

    s16 * writebuffer = (s16*)buffer;

    if(Sound.samples_left_to_output < len/4) return;

    Sound.samples_left_to_input += len/4;
    Sound.samples_left_to_output -= len/4;

    int i;
    for(i = 0; i < len/2; i++)
    {
        writebuffer[i] = Sound.buffer[Sound.buffer_next_output_sample++];
        Sound.buffer_next_output_sample &= GBA_BUFFER_SAMPLES-1;
    }
}

void GBA_SoundResetBufferPointers(void)
{
    Sound.buffer_next_input_sample = 0;
    Sound.buffer_next_output_sample = 0;
    Sound.samples_left_to_input = GBA_BUFFER_SAMPLES;
    Sound.samples_left_to_output = 0;
}

void GBA_SoundInit(void)
{
    memset(&Sound,0,sizeof(Sound));
    GBA_SoundResetBufferPointers();
    output_enabled = 1;
    //Prepare memory...

    Sound.leftvol_1 = Sound.rightvol_1 = 0;
    Sound.leftvol_2 = Sound.rightvol_2 = 0;
    Sound.leftvol_3 = Sound.rightvol_3 = 0;
    Sound.leftvol_4 = Sound.rightvol_4 = 0;
    Sound.leftvol_A = Sound.rightvol_A = 0;
    Sound.leftvol_B = Sound.rightvol_B = 0;

    Sound.FifoA.cursample = 0;
    Sound.FifoA.cursamplewrite = 0;
    Sound.FifoA.datalen = 0;
    memset(Sound.FifoA.buffer,0,sizeof(Sound.FifoA.buffer));
    Sound.FifoB.cursample = 0;
    Sound.FifoB.cursamplewrite = 0;
    Sound.FifoB.datalen = 0;
    memset(Sound.FifoB.buffer,0,sizeof(Sound.FifoB.buffer));

    //Set registers to initial values...
    GBA_SoundRegWrite16(SOUND1CNT_L,0);
    GBA_SoundRegWrite16(SOUND1CNT_H,0);
    GBA_SoundRegWrite16(SOUND1CNT_X,0);
    GBA_SoundRegWrite16(SOUND2CNT_L,0);
    GBA_SoundRegWrite16(SOUND2CNT_H,0);
    GBA_SoundRegWrite16(SOUND3CNT_L,0);
    GBA_SoundRegWrite16(SOUND3CNT_H,0);
    GBA_SoundRegWrite16(SOUND3CNT_X,0);
    GBA_SoundRegWrite16(SOUND4CNT_L,0);
    GBA_SoundRegWrite16(SOUND4CNT_H,0);
    GBA_SoundRegWrite16(SOUNDCNT_L,0);
    GBA_RegisterWrite16(SOUNDCNT_H,0x880E);
    GBA_SoundRegWrite16(SOUNDCNT_X,0);

    GBA_SoundRegWrite16(SOUNDBIAS,0);

	GBA_SoundPowerOn();

    Sound.Chn1.running = 0;
    Sound.Chn2.running = 0;
    Sound.Chn3.running = 0;
    Sound.Chn4.running = 0;

    Sound.FifoA.running = 0;
    Sound.FifoB.running = 0;

    int i;
    for(i = 0; i < 32; i+=2)
    {
        Sound.Chn3.wave_ram_buffer[0][i] = 0x00;
        Sound.Chn3.wave_ram_buffer[0][i+1] = 0xFF;

        Sound.Chn3.wave_ram_buffer[1][i] = 0x00;
        Sound.Chn3.wave_ram_buffer[1][i+1] = 0xFF;
    }
}

void GBA_SoundLoadWave(void)
{
	s8 * bufferptr = WavePattern;

    if(Sound.Chn3.doublesize)
    {
        u8 * srcptr = Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1];

        u32 count;
        for(count = 0; count < 0x10; count ++)
        {
            *bufferptr++ = (srcptr[count] & 0xF0) - 127;
            *bufferptr++ = ((srcptr[count] & 0x0F) << 4) - 127;
        }

        srcptr = Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing];

        for(count = 0; count < 0x10; count ++)
        {
            *bufferptr++ = (srcptr[count] & 0xF0) - 127;
            *bufferptr++ = ((srcptr[count] & 0x0F) << 4) - 127;
        }
    }
    else //repeat the same 2 times in the buffer
    {
        u8 * srcptr = Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing];

        u32 count;
        for(count = 0; count < 0x10; count ++)
        {
            *bufferptr++ = (srcptr[count] & 0xF0) - 127;
            *bufferptr++ = ((srcptr[count] & 0x0F) << 4) - 127;
        }

        for(count = 0; count < 0x10; count ++)
        {
            *bufferptr++ = (srcptr[count] & 0xF0) - 127;
            *bufferptr++ = ((srcptr[count] & 0x0F) << 4) - 127;
        }
    }
}

void GBA_ToggleSound(void)
{
    output_enabled ^= 1;
    if(output_enabled) GBA_SoundResetBufferPointers();
}

void GBA_SoundMix(void)
{
    //if(output_enabled == 0) return;
    if(EmulatorConfig.snd_mute) return;

    if(Sound.samples_left_to_input < 1) return;

    Sound.samples_left_to_input--;
    Sound.samples_left_to_output++;

    if(Sound.master_enable == 0)
    {
        Sound.buffer[Sound.buffer_next_input_sample++] = 0;
        Sound.buffer[Sound.buffer_next_input_sample++] = 0;
        Sound.buffer_next_input_sample &= GBA_BUFFER_SAMPLES-1;
        return;
    }

    s32 outvalue_left = 0, outvalue_right = 0;

    if(Sound.Chn1.running && (EmulatorConfig.chn_flags&0x1))
    {
        int out_1 = (int)SquareWave[Sound.Chn1.duty][(((Sound.Chn1.samplecount++)*((Sound.Chn1.outfreq) * (32/2)))/ 22050)&31];
        outvalue_left += out_1 * Sound.leftvol_1;
        outvalue_right += out_1 * Sound.rightvol_1;
    }
    if(Sound.Chn2.running && (EmulatorConfig.chn_flags&0x2))
    {
        int out_2 = (int)SquareWave[Sound.Chn2.duty][(((Sound.Chn2.samplecount++)*((Sound.Chn2.outfreq) * (32/2)))/ 22050)&31];
        outvalue_left += out_2 * Sound.leftvol_2;
        outvalue_right += out_2 * Sound.rightvol_2;
    }
    if(Sound.Chn3.running && (EmulatorConfig.chn_flags&0x4))
    {
        int out_3 = (int)WavePattern[(((Sound.Chn3.samplecount++)*((Sound.Chn3.outfreq) * (32/2)))/ 22050)&63];
        outvalue_left += out_3 * Sound.leftvol_3;
        outvalue_right += out_3 * Sound.rightvol_3;
    }
    if(Sound.Chn4.running && (EmulatorConfig.chn_flags&0x8))
    {
        int out_4;
        int value = (((Sound.Chn4.samplecount++)*Sound.Chn4.outfreq / 2)/ 22050);

        if(Sound.Chn4.width_7) // 7 bit
        {
            out_4 = noise_7[(value/8)&15] >> (7-(value&7));
        }
        else // 15 bit
        {
            out_4 = noise_15[(value/8)&4095] >> (7-(value&7));
        }

        out_4 &= 1;
        out_4 = ((out_4 * 2) - 1) * 127;
        outvalue_left += out_4 * Sound.leftvol_4;
        outvalue_right += out_4 * Sound.rightvol_4;
    }
    outvalue_left = (outvalue_left * Sound.PSG_master_volume)>>1; //PSG_master_volume = 0..2
    outvalue_right = (outvalue_right * Sound.PSG_master_volume)>>1;
    //-128..128 * 0..8 * 0..16 = -16384 .. +16384
    //each PSG channel -> -16384 .. +16384

    if(Sound.FifoA.running && (EmulatorConfig.chn_flags&0x10))
    {
        int out_A = (int)(s8)Sound.FifoA.out_sample;
        outvalue_left += out_A * Sound.leftvol_A * 256;//leftvol_A = 0..2
        outvalue_right += out_A * Sound.rightvol_A * 256;
    }
    if(Sound.FifoB.running && (EmulatorConfig.chn_flags&0x20))
    {
        int out_B = (int)(s8)Sound.FifoB.out_sample;
        outvalue_left += out_B * Sound.leftvol_B * 256; //leftvol_B = 0..2
        outvalue_right += out_B * Sound.rightvol_B * 256;
    }
    //-128..128 * 0..2 * 256 = -65536 .. +65536
    //fifo channels -> -65536 .. +65536

    //add everything, total -> -81920 .. +81920 -- clamp to -65536 .. +65536
    //¿¿ clamp to bias/200h * 65536 ??

    if(outvalue_left > 65535) outvalue_left = 65535;
    else if(outvalue_left < (-65536)) outvalue_left = -65536;

    if(outvalue_right > 65535) outvalue_right = 65535;
    else if(outvalue_right < (-65536)) outvalue_right = -65536;

    outvalue_left >>= 1;
    outvalue_right >>= 1;

    Sound.buffer[Sound.buffer_next_input_sample++] = (outvalue_left * EmulatorConfig.volume) / 128;
    Sound.buffer[Sound.buffer_next_input_sample++] = (outvalue_right * EmulatorConfig.volume) / 128;
    Sound.buffer_next_input_sample &= GBA_BUFFER_SAMPLES-1;
}


u32 GBA_SoundUpdate(u32 clocks) //Every 65535 clocks update hardware, every ~512 generate output
{
	Sound.clocks += clocks;

    if(output_enabled)
    {
        Sound.nextsample_clocks += clocks;

        //16777216 Hz?

        //16.78 MHz CPU / 22050 = 761
        //16.78 MHz CPU / 32768 Hz sound output = 512
        if(Sound.samples_left_to_output > Sound.samples_left_to_input-(GBA_BUFFER_SAMPLES/2))
        {
            if(Sound.nextsample_clocks > (761 + 10))
            {
                Sound.nextsample_clocks -= (761 + 10);
                GBA_SoundMix();
            }
        }               //This is an ugly hack to make sound buffer not overflow or underflow...
        else
        {
            if(Sound.nextsample_clocks > (761 - 10))
            {
                Sound.nextsample_clocks -= (761 - 10);
                GBA_SoundMix();
            }
        }
    }

    //16.78 MHz CPU / 256 Steps per second (aprox)
	if(Sound.clocks > 65535) Sound.clocks -= 65536;
	else return 65536-Sound.clocks;

	if(Sound.master_enable == 0) return 65536-Sound.clocks;

	//Channel 1
    if(Sound.Chn1.running)
    {
        if(Sound.Chn1.limittime)
        {
            if(Sound.Chn1.stepsleft > 0) Sound.Chn1.stepsleft --;
            else
            {
                Sound.Chn1.running = 0;
                Sound.Chn1.envactive = 0;
                REG_SOUNDCNT_X &= ~(1<<0);
            }
        }
        if(Sound.Chn1.envactive && Sound.Chn1.envelope)
        {
            if(Sound.Chn1.envstepstochange == 0)
            {
                Sound.Chn1.envstepstochange = Sound.Chn1.envelope << 2;

                if(Sound.Chn1.envincrease)
                {
                    if(Sound.Chn1.vol < 0x0F)
                    {
                        Sound.Chn1.vol ++;
                        Sound.leftvol_1 = Sound.Chn1.speakerleft ? (Sound.Chn1.vol * Sound.leftvol) : 0;
                        Sound.rightvol_1 = Sound.Chn1.speakerright ? (Sound.Chn1.vol * Sound.rightvol) : 0;
                    }
                    else Sound.Chn1.envactive = 0;
                }
                else
                {
                    if(Sound.Chn1.vol > 0)
                    {
                        Sound.Chn1.vol --;
                        Sound.leftvol_1 = Sound.Chn1.speakerleft ? (Sound.Chn1.vol * Sound.leftvol) : 0;
                        Sound.rightvol_1 = Sound.Chn1.speakerright ? (Sound.Chn1.vol * Sound.rightvol) : 0;
                    }
                    else Sound.Chn1.envactive = 0;
                }
            }
            else Sound.Chn1.envstepstochange --;
        }
        if(Sound.Chn1.sweeptime > 0)
        {
            if(Sound.Chn1.sweepstepsleft == 0)
            {
                Sound.Chn1.sweepstepsleft = Sound.Chn1.sweeptime << 1;

                if(Sound.Chn1.sweepinc)
                {
                    Sound.Chn1.sweepfreq += Sound.Chn1.sweepfreq / (1<<Sound.Chn1.sweepshift);
                }
                else
                {
                    Sound.Chn1.sweepfreq -= Sound.Chn1.sweepfreq / (1<<Sound.Chn1.sweepshift);
                }

                Sound.Chn1.outfreq = 131072/(2048-Sound.Chn1.sweepfreq);
            }
            else Sound.Chn1.sweepstepsleft --;
        }
    }

	//Channel 2
	if(Sound.Chn2.running)
	{
        if(Sound.Chn2.limittime)
        {
            if(Sound.Chn2.stepsleft > 0) Sound.Chn2.stepsleft --;
            else
            {
                Sound.Chn2.running = 0;
                Sound.Chn2.envactive = 0;
                REG_SOUNDCNT_X &= ~(1<<1);
            }
        }
        if(Sound.Chn2.envactive && Sound.Chn2.envelope)
        {
            if(Sound.Chn2.envstepstochange == 0)
            {
                Sound.Chn2.envstepstochange = Sound.Chn2.envelope << 2;

                if(Sound.Chn2.envincrease)
                {
                    if(Sound.Chn2.vol < 0x0F)
                    {
                        Sound.Chn2.vol ++;
                        Sound.leftvol_2 = Sound.Chn2.speakerleft ? (Sound.Chn2.vol * Sound.leftvol) : 0;
                        Sound.rightvol_2 = Sound.Chn2.speakerright ? (Sound.Chn2.vol * Sound.rightvol) : 0;
                    }
                    else Sound.Chn2.envactive = 0;
                }
                else
                {
                    if(Sound.Chn2.vol > 0)
                    {
                        Sound.Chn2.vol --;
                        Sound.leftvol_2 = Sound.Chn2.speakerleft ? (Sound.Chn2.vol * Sound.leftvol) : 0;
                        Sound.rightvol_2 = Sound.Chn2.speakerright ? (Sound.Chn2.vol * Sound.rightvol) : 0;
                    }
                    else Sound.Chn2.envactive = 0;
                }
            }
            else Sound.Chn2.envstepstochange --;
        }
	}

	//Channel 3
	if(Sound.Chn3.running)
	{
        if(Sound.Chn3.stepsleft > 0) Sound.Chn3.stepsleft --;
        else if(Sound.Chn3.limittime)
        {
            Sound.Chn3.running = 0;
            REG_SOUNDCNT_X &= ~(1<<2);
        }
	}

	//Channel 4
	if(Sound.Chn4.running)
	{
        if(Sound.Chn4.limittime)
        {
            if(Sound.Chn4.stepsleft > 0) Sound.Chn4.stepsleft --;
            else
            {
                Sound.Chn4.running = 0;
                Sound.Chn4.envactive = 0;
                REG_SOUNDCNT_X &= ~(1<<3);
            }
        }
        if(Sound.Chn4.envactive && Sound.Chn4.envelope)
        {
            if(Sound.Chn4.envstepstochange == 0)
            {
                Sound.Chn4.envstepstochange = Sound.Chn4.envelope << 2;

                if(Sound.Chn4.envincrease)
                {
                    if(Sound.Chn4.vol < 0x0F)
                    {
                        Sound.Chn4.vol ++;
                        Sound.leftvol_4 = Sound.Chn4.speakerleft ? (Sound.Chn4.vol * Sound.leftvol) : 0;
                        Sound.rightvol_4 = Sound.Chn4.speakerright ? (Sound.Chn4.vol * Sound.rightvol) : 0;
                    }
                    else Sound.Chn4.envactive = 0;
                }
                else
                {
                    if(Sound.Chn4.vol > 0)
                    {
                        Sound.Chn4.vol --;
                        Sound.leftvol_4 = Sound.Chn4.speakerleft ? (Sound.Chn4.vol * Sound.leftvol) : 0;
                        Sound.rightvol_4 = Sound.Chn4.speakerright ? (Sound.Chn4.vol * Sound.rightvol) : 0;
                    }
                    else Sound.Chn4.envactive = 0;
                }
            }
            else Sound.Chn4.envstepstochange --;
        }
	}

	return 65536-Sound.clocks;
}

void GBA_SoundRegWrite16(u32 address, u16 value)
{
    //fprintf(stdout,"%08x - %04x\r\n",address,value);

    if(Sound.master_enable == 0)
    {
        if((address == SOUNDCNT_X) && (value & (1<<7)))
        {
            GBA_SoundPowerOn();
            Sound.master_enable = 1;
        }
        if(address == SOUNDBIAS)
        {
            return;
        }
        return;
    }

	switch(address)
	{
		//Voice 1
		case SOUND1CNT_L:
            Sound.Chn1.reg[0] = value;
            //don't update sweep yet...
			return;
		case SOUND1CNT_H:
            Sound.Chn1.reg[1] = value;

            Sound.Chn1.stepsleft = (64-(value &0x3F)) << 2;
            Sound.Chn1.duty = (value>>6)&3;

            //don't update envelope yet...
            if(Sound.Chn1.running) //"zombie mode"
            {
                if( Sound.Chn1.envactive && (Sound.Chn1.envelope == 0) )
                    Sound.Chn1.vol = (Sound.Chn1.vol + 1) & 0xF;
                else if( (value & (1<<11)) == 0)
                    Sound.Chn1.vol = (Sound.Chn1.vol + 2) & 0xF;

                Sound.leftvol_1 = Sound.Chn1.speakerleft ? (Sound.Chn1.vol * Sound.leftvol) : 0;
                Sound.rightvol_1 = Sound.Chn1.speakerright ? (Sound.Chn1.vol * Sound.rightvol) : 0;
            }
			return;
		case SOUND1CNT_X:
			Sound.Chn1.freq = value & 0x07FF;
			Sound.Chn1.outfreq = 131072/(2048-Sound.Chn1.freq);
			Sound.Chn1.limittime = (value & (1<<14));
			if(value & (1<<15))
			{
			    Sound.Chn1.running = 1;

                //update sweep
			    Sound.Chn1.sweeptime = (Sound.Chn1.reg[0] >> 4) & 0x07;
                Sound.Chn1.sweepstepsleft = Sound.Chn1.sweeptime << 1;
                Sound.Chn1.sweepinc = ( (Sound.Chn1.reg[0] & (1<<3)) == 0 );
                Sound.Chn1.sweepshift = Sound.Chn1.reg[0] & 0x07;
                Sound.Chn1.sweepfreq = Sound.Chn1.freq;

                //update envelope
                Sound.Chn1.vol = (Sound.Chn1.reg[1] >> 12);
                Sound.Chn1.envelope = (Sound.Chn1.reg[1]>>8) & 0x07;
                Sound.Chn1.envactive = 1; //Sound.Chn1.envelope != 0;
                Sound.Chn1.envincrease = Sound.Chn1.reg[1] & (1<<11);
                Sound.Chn1.envstepstochange = Sound.Chn1.envelope << 2;
                Sound.leftvol_1 = Sound.Chn1.speakerleft ? (Sound.Chn1.vol * Sound.leftvol) : 0;
                Sound.rightvol_1 = Sound.Chn1.speakerright ? (Sound.Chn1.vol * Sound.rightvol) : 0;

				REG_SOUNDCNT_X |= (1<<0);
			}
			else
			{
			//	REG_SOUNDCNT_X &= ~(1<<0);
			}
			return;

		//Voice 2
		case SOUND2CNT_L:
            Sound.Chn2.reg[1] = value;

            Sound.Chn2.stepsleft = (64-(value &0x3F)) << 2;
            Sound.Chn2.duty = (value>>6)&3;

            //don't update envelope yet...
            if(Sound.Chn2.running) //"zombie mode"
            {
                if( Sound.Chn2.envactive && (Sound.Chn2.envelope == 0) )
                    Sound.Chn2.vol = (Sound.Chn2.vol + 1) & 0xF;
                else if( (value & (1<<11)) == 0)
                    Sound.Chn2.vol = (Sound.Chn2.vol + 2) & 0xF;

                Sound.leftvol_2 = Sound.Chn2.speakerleft ? (Sound.Chn2.vol * Sound.leftvol) : 0;
                Sound.rightvol_2 = Sound.Chn2.speakerright ? (Sound.Chn2.vol * Sound.rightvol) : 0;
            }
			return;
		case SOUND2CNT_H:
			Sound.Chn2.freq = value & 0x07FF;
			Sound.Chn2.outfreq = 131072/(2048-Sound.Chn2.freq);
			Sound.Chn2.limittime = (value & (1<<14));
			if(value & (1<<15))
			{
			    Sound.Chn2.running = 1;

                //update envelope
                Sound.Chn2.vol = (Sound.Chn2.reg[1] >> 12);
                Sound.Chn2.envelope = (Sound.Chn2.reg[1]>>8) & 0x07;
                Sound.Chn2.envactive = 1; //Sound.Chn2.envelope != 0;
                Sound.Chn2.envincrease = Sound.Chn2.reg[1] & (1<<11);
                Sound.Chn2.envstepstochange = Sound.Chn2.envelope << 2;
                Sound.leftvol_2 = Sound.Chn2.speakerleft ? (Sound.Chn2.vol * Sound.leftvol) : 0;
                Sound.rightvol_2 = Sound.Chn2.speakerright ? (Sound.Chn2.vol * Sound.rightvol) : 0;

				REG_SOUNDCNT_X |= (1<<1);
			}
			else
			{
			//	REG_SOUNDCNT_X &= ~(1<<1);
			}
			return;

		//Voice 3
		case SOUND3CNT_L:
            Sound.Chn3.reg[0] = value;

            Sound.Chn3.doublesize = (value & BIT(5)) ? 1 : 0;
            Sound.Chn3.buffer_playing = (value & BIT(6)) ? 1 : 0;

			if(value & (1<<7))
			{
				REG_SOUNDCNT_X |= (1<<2);
				GBA_SoundLoadWave();
                Sound.Chn3.samplecount = 0;
				Sound.Chn3.outfreq = 131072/(2048-Sound.Chn3.freq);
				Sound.Chn3.playing = 1;
			}
			else
			{
				Sound.Chn3.playing = 0;
				REG_SOUNDCNT_X &= ~(1<<2);
                Sound.Chn3.running = 0;
			}
			return;
		case SOUND3CNT_H:
            Sound.Chn3.reg[1] = value;

			Sound.Chn3.stepsleft = (256-value) << 2;

            if(value & BIT(15)) Sound.Chn3.vol = 0xC;
            else
            {
                switch( (value >> 13) & 3)
                {
                    case 0: Sound.Chn3.vol = 0x0; break;
                    case 1: Sound.Chn3.vol = 0xF; break;
                    case 2: Sound.Chn3.vol = 0x7; break;
                    case 3: Sound.Chn3.vol = 0x3; break;
                }
            }

			Sound.leftvol_3 = Sound.Chn3.speakerleft ? (Sound.Chn3.vol * Sound.leftvol) : 0;
            Sound.rightvol_3 = Sound.Chn3.speakerright ? (Sound.Chn3.vol * Sound.rightvol) : 0;
			return;
		case SOUND3CNT_X:
            Sound.Chn3.reg[2] = value;

			Sound.Chn3.freq = value&0x07FF;

			if(Sound.Chn3.playing)
			{
				Sound.Chn3.outfreq = 131072/(2048-Sound.Chn3.freq);
			}

			Sound.Chn3.limittime = (value & (1<<6));

            if(Sound.Chn3.playing) // ?
            {
                if(value & (1<<15))
                {
                    //Sound.Chn3.playing = 1; // ?
                    Sound.Chn3.samplecount = 0;
                    REG_SOUNDCNT_X |= (1<<2);
                    GBA_SoundLoadWave();
                    Sound.Chn3.running = 1;
                }
            }
			return;

		//Voice 4
		case SOUND4CNT_L:
            Sound.Chn4.reg[1] = value;

			Sound.Chn4.stepsleft = (64-(value &0x3F)) << 2;

            //don't update envelope yet...

            //no zombie mode in channel 4?
            //if(Sound.Chn4.running) //"zombie mode"
            //{
            //    if( Sound.Chn4.envactive && (Sound.Chn4.envelope == 0) )
            //        Sound.Chn4.vol = (Sound.Chn4.vol + 1) & 0xF;
            //    else if( (Sound.Chn4.reg[1] & (1<<11)) == 0)
            //        Sound.Chn4.vol = (Sound.Chn4.vol + 2) & 0xF;
            //
            //    Sound.leftvol_4 = Sound.Chn4.speakerleft ? (Sound.Chn4.vol * Sound.leftvol) : 0;
            //    Sound.rightvol_4 = Sound.Chn4.speakerright ? (Sound.Chn4.vol * Sound.rightvol) : 0;
            //}
			return;
		case SOUND4CNT_H:
            Sound.Chn4.reg[2] = value;

			Sound.Chn4.shift = ( value >> 4 ) & 0x0F;
			Sound.Chn4.width_7 = value & (1<<3);
			Sound.Chn4.freq_ratio = value & 0x07;

			if(Sound.Chn4.shift > 13)
			{
			    Sound.Chn4.outfreq = 0;
			    return;
			}

            //const s32 NoiseFreqRatio[8] = {1048576,524288,370728,262144,220436,185364,155872,131072 };
            const s32 NoiseFreqRatio[8] = {1048576,524288,262144,174763,131072,104858,87381,74898 };

            Sound.Chn4.outfreq = NoiseFreqRatio[Sound.Chn4.freq_ratio] >> (Sound.Chn4.shift + 1);
            if(Sound.Chn4.outfreq > (1<<18)) Sound.Chn4.outfreq = 1<<18;

			Sound.Chn4.limittime = (value & (1<<14));

			if(value & (1<<15))
			{
                Sound.Chn4.running = 1;

                //update envelope
                Sound.Chn4.vol = (Sound.Chn4.reg[1] >> 13);
                Sound.Chn4.envelope = (Sound.Chn4.reg[1]>>8) & 0x07;
                Sound.Chn4.envactive = 1; //Sound.Chn4.envelope != 0;
                Sound.Chn4.envincrease = Sound.Chn4.reg[1] & (1<<11);
                Sound.Chn4.envstepstochange = Sound.Chn4.envelope << 2;
                Sound.leftvol_4 = Sound.Chn4.speakerleft ? (Sound.Chn4.vol * Sound.leftvol) : 0;
                Sound.rightvol_4 = Sound.Chn4.speakerright ? (Sound.Chn4.vol * Sound.rightvol) : 0;

				REG_SOUNDCNT_X |= (1<<3);
			}
			else
			{
				//REG_SOUNDCNT_X &= ~(1<<3);
			}
			return;


		//Control
		case SOUNDCNT_L:
			Sound.rightvol = value & 0x7;
			Sound.leftvol = (value>>4) & 0x7;
            Sound.leftvol_1 = Sound.Chn1.speakerleft ? (Sound.Chn1.vol * Sound.leftvol) : 0;
            Sound.rightvol_1 = Sound.Chn1.speakerright ? (Sound.Chn1.vol * Sound.rightvol) : 0;
            Sound.leftvol_2 = Sound.Chn2.speakerleft ? (Sound.Chn2.vol * Sound.leftvol) : 0;
            Sound.rightvol_2 = Sound.Chn2.speakerright ? (Sound.Chn2.vol * Sound.rightvol) : 0;
            Sound.leftvol_3 = Sound.Chn3.speakerleft ? (Sound.Chn3.vol * Sound.leftvol) : 0;
            Sound.rightvol_3 = Sound.Chn3.speakerright ? (Sound.Chn3.vol * Sound.rightvol) : 0;
            Sound.leftvol_4 = Sound.Chn4.speakerleft ? (Sound.Chn4.vol * Sound.leftvol) : 0;
            Sound.rightvol_4 = Sound.Chn4.speakerright ? (Sound.Chn4.vol * Sound.rightvol) : 0;
			Sound.Chn1.speakerright = (value & (1<<8));
			Sound.Chn1.speakerleft = (value & (1<<12));
			Sound.Chn2.speakerright = (value & (1<<9));
			Sound.Chn2.speakerleft = (value & (1<<13));
			Sound.Chn3.speakerright = (value & (1<<10));
			Sound.Chn3.speakerleft = (value & (1<<14));
			Sound.Chn4.speakerright = (value & (1<<11));
			Sound.Chn4.speakerleft = (value & (1<<15));
			Sound.leftvol_1 = Sound.Chn1.speakerleft ? (Sound.Chn1.vol * Sound.leftvol) : 0;
            Sound.rightvol_1 = Sound.Chn1.speakerright ? (Sound.Chn1.vol * Sound.rightvol) : 0;
            Sound.leftvol_2 = Sound.Chn2.speakerleft ? (Sound.Chn2.vol * Sound.leftvol) : 0;
            Sound.rightvol_2 = Sound.Chn2.speakerright ? (Sound.Chn2.vol * Sound.rightvol) : 0;
            Sound.leftvol_3 = Sound.Chn3.speakerleft ? (Sound.Chn3.vol * Sound.leftvol) : 0;
            Sound.rightvol_3 = Sound.Chn3.speakerright ? (Sound.Chn3.vol * Sound.rightvol) : 0;
            Sound.leftvol_4 = Sound.Chn4.speakerleft ? (Sound.Chn4.vol * Sound.leftvol) : 0;
            Sound.rightvol_4 = Sound.Chn4.speakerright ? (Sound.Chn4.vol * Sound.rightvol) : 0;
			return;
        case SOUNDCNT_H:
        {
            static const int vol[4] = { 0, 1, 2, 0 };
            Sound.PSG_master_volume = vol[value&3];

            Sound.FifoA.speakerright = (value & BIT(8));
			Sound.FifoA.speakerleft = (value & BIT(9));
			Sound.FifoB.speakerright = (value & BIT(12));
			Sound.FifoB.speakerleft = (value & BIT(13));

            Sound.FifoA.vol = (value&BIT(2)) ? 1 : 2;
            Sound.leftvol_A = Sound.FifoA.speakerleft ? Sound.FifoA.vol : 0;
            Sound.rightvol_A = Sound.FifoA.speakerright ? Sound.FifoA.vol : 0;

            Sound.FifoB.vol = (value&BIT(3)) ? 1 : 2;
            Sound.leftvol_B = Sound.FifoB.speakerleft ? Sound.FifoB.vol : 0;
            Sound.rightvol_B = Sound.FifoB.speakerright ? Sound.FifoB.vol : 0;

            Sound.FifoA.timer = (value & BIT(10)) ? 1 : 0;
            Sound.FifoB.timer = (value & BIT(14)) ? 1 : 0;

            if(value & BIT(11))
            {
                Sound.FifoA.cursample = 0;
                Sound.FifoA.cursamplewrite = 0;
                Sound.FifoA.datalen = 0;
                memset(Sound.FifoA.buffer,0,sizeof(Sound.FifoA.buffer));
            }

            if(value & BIT(15))
            {
                Sound.FifoB.cursample = 0;
                Sound.FifoB.cursamplewrite = 0;
                Sound.FifoB.datalen = 0;
                memset(Sound.FifoB.buffer,0,sizeof(Sound.FifoB.buffer));
            }
            return;
        }
		case SOUNDCNT_X:
			if((value & (1<<7)) == 0)
			{
				GBA_SoundPowerOff();
				Sound.master_enable = 0;
			}
            return;

        case WAVE_RAM+0:
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][0] = value&0xFF;
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][1] = (value>>8)&0xFF;
            return;
        case WAVE_RAM+2:
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][2] = value&0xFF;
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][3] = (value>>8)&0xFF;
            return;
        case WAVE_RAM+4:
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][4] = value&0xFF;
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][5] = (value>>8)&0xFF;
            return;
        case WAVE_RAM+6:
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][6] = value&0xFF;
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][7] = (value>>8)&0xFF;
            return;
        case WAVE_RAM+8:
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][8] = value&0xFF;
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][9] = (value>>8)&0xFF;
            return;
        case WAVE_RAM+10:
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][10] = value&0xFF;
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][11] = (value>>8)&0xFF;
            return;
        case WAVE_RAM+12:
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][12] = value&0xFF;
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][13] = (value>>8)&0xFF;
            return;
        case WAVE_RAM+14:
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][14] = value&0xFF;
            Sound.Chn3.wave_ram_buffer[Sound.Chn3.buffer_playing^1][15] = (value>>8)&0xFF;
            return;

        case FIFO_A+0:
            Sound.FifoA.buffer[Sound.FifoA.cursamplewrite+0] = value&0xFF;
            Sound.FifoA.buffer[Sound.FifoA.cursamplewrite+1] = (value>>8)&0xFF;
            Sound.FifoA.datalen += 2;
            return;
        case FIFO_A+2:
            Sound.FifoA.buffer[Sound.FifoA.cursamplewrite+2] = value&0xFF;
            Sound.FifoA.buffer[Sound.FifoA.cursamplewrite+3] = (value>>8)&0xFF;
            Sound.FifoA.datalen += 2;
            Sound.FifoA.cursamplewrite += 4;
            Sound.FifoA.cursamplewrite &= FIFO_BUFFER_SIZE-1;
            return;
        case FIFO_B+0:
            Sound.FifoB.buffer[Sound.FifoB.cursamplewrite+0] = value&0xFF;
            Sound.FifoB.buffer[Sound.FifoB.cursamplewrite+1] = (value>>8)&0xFF;
            Sound.FifoB.datalen += 2;
            return;
        case FIFO_B+2:
            Sound.FifoB.buffer[Sound.FifoB.cursamplewrite+2] = value&0xFF;
            Sound.FifoB.buffer[Sound.FifoB.cursamplewrite+3] = (value>>8)&0xFF;
            Sound.FifoB.datalen += 2;
            Sound.FifoB.cursamplewrite += 4;
            Sound.FifoB.cursamplewrite &= FIFO_BUFFER_SIZE-1;
            return;

        case SOUNDBIAS:
            return;
        default:
            DebugMessage("GBA Sound: [%08x]=%04x (?)\n",address,value);
            GBA_ExecutionBreak();
            return;
	}
}

void GBA_SoundTimerCheck(int number)
{
    if(Sound.FifoA.timer == number)
    {
        Sound.FifoA.running = 0;
        if(Sound.FifoA.datalen > 0)
        {
            Sound.FifoA.datalen --;
            Sound.FifoA.out_sample = Sound.FifoA.buffer[Sound.FifoA.cursample++];
            Sound.FifoA.cursample &= FIFO_BUFFER_SIZE-1;
            Sound.FifoA.running = 1;
        }
        if(Sound.FifoA.datalen <= 16) //request data!!!
            GBA_DMASoundRequestData(1,0);
    }

    if(Sound.FifoB.timer == number)
    {
        Sound.FifoB.running = 0;
        if(Sound.FifoB.datalen > 0)
        {
            Sound.FifoB.datalen --;
            Sound.FifoB.out_sample = Sound.FifoB.buffer[Sound.FifoB.cursample++];
            Sound.FifoB.cursample &= FIFO_BUFFER_SIZE-1;
            Sound.FifoB.running = 1;
        }
        if(Sound.FifoB.datalen <= 16) //request data!!!
            GBA_DMASoundRequestData(0,1);
    }
}

void GBA_SoundEnd(void)
{
}

//-----------------------------------------------

void GBA_SoundGetConfig(int * vol, int * chn_flags)
{
    *vol = EmulatorConfig.volume;
    *chn_flags = EmulatorConfig.chn_flags;
}

void GBA_SoundSetConfig(int vol, int chn_flags)
{
    EmulatorConfig.volume = vol;
    EmulatorConfig.chn_flags = chn_flags;
}

//-------------------------------------------------

int gba_debug_get_psg_vol(int chan)
{
    switch(chan)
    {
        case 1: return Sound.Chn1.vol;
        case 2: return Sound.Chn2.vol;
        case 3: return Sound.Chn3.vol;
        case 4: return Sound.Chn4.vol;
        default: return 0;
    }
}
